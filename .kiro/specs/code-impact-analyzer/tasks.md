# 实现计划: 代码影响分析工具

## 概述

本实现计划将代码影响分析工具分解为增量开发的任务。每个任务都构建在前面的任务之上，确保系统逐步完善。实现将使用 Rust 语言，采用模块化架构，支持扩展。

## 任务列表

- [x] 1. 项目初始化和核心数据结构
  - 创建 Rust 项目结构（使用 cargo new）
  - 在 Cargo.toml 中添加依赖：tree-sitter, gitpatch, petgraph, quick-xml, serde_yaml, clap, rayon, proptest, regex, log, env_logger
  - 定义核心数据结构：MethodLocation, HttpAnnotation, KafkaOperation, DbOperation, RedisOperation, Import
  - 定义错误类型：AnalysisError, ParseError, IndexError, TraceError
  - _需求: 1.1, 2.1, 6.1, 7.1, 12.1_

- [ ]* 1.1 为核心数据结构编写属性测试
  - **属性 48: 缓存一致性**
  - **验证需求: 13.2**

- [ ] 2. 实现 Patch Parser 模块
  - [x] 2.1 实现 PatchParser 结构体和基本接口
    - 使用 gitpatch crate 解析 Git unified diff 格式
    - 实现 parse_patch_file 方法提取 FileChange 列表
    - 实现 extract_modified_methods 方法识别变更的方法
    - _需求: 1.1, 1.2, 1.5_

  - [ ]* 2.2 为 Patch Parser 编写属性测试
    - **属性 1: Patch 文件路径提取完整性**
    - **验证需求: 1.1**

  - [ ]* 2.3 为 Patch Parser 编写属性测试
    - **属性 2: 方法变更识别准确性**
    - **验证需求: 1.2**

  - [ ]* 2.4 为 Patch Parser 编写属性测试
    - **属性 3: 无效 patch 错误处理**
    - **验证需求: 1.3**

  - [ ]* 2.5 为 Patch Parser 编写属性测试
    - **属性 4: Patch 解析往返一致性**
    - **验证需求: 1.5**

  - [ ]* 2.6 编写单元测试
    - 测试标准 Git diff 格式
    - 测试多文件 patch
    - 测试二进制文件处理（边缘情况 1.4）
    - 测试无效格式错误处理
    - _需求: 1.3, 1.4_

- [ ] 3. 实现 Language Parser 模块
  - [x] 3.1 定义 LanguageParser trait 和相关类型
    - 定义 LanguageParser trait 接口
    - 定义 ParsedFile, ClassInfo, MethodInfo, FunctionInfo 结构体
    - 实现语言识别逻辑（基于文件扩展名）
    - _需求: 2.4, 11.1_

  - [x] 3.2 实现 JavaParser
    - 集成 tree-sitter-java
    - 实现类和方法提取
    - 实现方法调用提取
    - 实现 Spring 注解识别（@RestController, @GetMapping 等）
    - 实现 SQL 语句提取（从字符串字面量）
    - 实现 Kafka 操作识别（KafkaProducer, @KafkaListener）
    - 实现 Redis 操作识别（RedisTemplate）
    - _需求: 2.1, 4.5, 5.1, 5.3, 6.1, 6.3, 7.1, 7.3_

  - [ ]* 3.3 为 JavaParser 编写属性测试
    - **属性 5: Java 代码结构提取完整性**
    - **验证需求: 2.1**

  - [ ]* 3.4 为 JavaParser 编写属性测试
    - **属性 18: HTTP 框架注解识别覆盖性**
    - **验证需求: 4.5**

  - [x] 3.5 实现 RustParser
    - 集成 tree-sitter-rust
    - 实现函数和模块提取
    - 实现函数调用提取
    - 实现 Axum 路由宏识别
    - 实现 Kafka 操作识别（FutureProducer, StreamConsumer）
    - 实现 Redis 操作识别（redis crate Commands trait）
    - _需求: 2.2, 4.5, 5.1, 5.3, 7.1, 7.3_

  - [ ]* 3.6 为 RustParser 编写属性测试
    - **属性 6: Rust 代码结构提取完整性**
    - **验证需求: 2.2**

  - [ ]* 3.7 为语言识别编写属性测试
    - **属性 7: 语言识别准确性**
    - **验证需求: 2.4**

  - [ ]* 3.8 为错误处理编写属性测试
    - **属性 8: 语法错误容错性**
    - **验证需求: 2.5**

  - [ ]* 3.9 编写单元测试
    - 测试 Java 基本类和方法提取
    - 测试 Rust 函数和模块提取
    - 测试嵌套结构
    - 测试不支持语言处理（边缘情况 2.3）
    - _需求: 2.3, 2.5_

- [ ] 4. 实现 Config Parser 模块
  - [x] 4.1 实现 ConfigParser trait 和实现类
    - 定义 ConfigParser trait 和 ConfigData 结构体
    - 实现 XmlConfigParser（使用 quick-xml）
    - 实现 YamlConfigParser（使用 serde_yaml）
    - 提取 HTTP 端点、Kafka Topic、数据库表、Redis 前缀
    - _需求: 10.1, 10.2, 10.5_

  - [ ]* 4.2 为 XML 解析编写属性测试
    - **属性 40: XML 配置提取准确性**
    - **验证需求: 10.1**

  - [ ]* 4.3 为 YAML 解析编写属性测试
    - **属性 41: YAML 配置提取准确性**
    - **验证需求: 10.2**

  - [ ]* 4.4 为配置提取编写属性测试
    - **属性 44: 数据库配置提取准确性**
    - **验证需求: 10.5**

  - [ ]* 4.5 编写单元测试
    - 测试标准 XML/YAML 格式
    - 测试嵌套配置结构
    - 测试无效格式处理
    - _需求: 10.1, 10.2_

- [x] 5. 检查点 - 确保所有解析器测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 6. 实现 Code Index Builder 模块
  - [x] 6.1 实现 CodeIndex 结构体和索引构建
    - 定义 CodeIndex 及其内部 HashMap 结构
    - 实现 index_workspace 方法遍历所有项目
    - 为每个文件选择合适的语言解析器
    - 构建方法调用索引（正向和反向）
    - 构建跨服务资源索引（HTTP/Kafka/DB/Redis）
    - _需求: 8.1, 8.2, 8.3, 8.4, 8.5, 8.6_

  - [x] 6.2 实现查询接口
    - 实现 find_method 方法
    - 实现 find_callers 和 find_callees 方法
    - 实现 find_http_consumers 方法
    - 实现 find_kafka_consumers/producers 方法
    - 实现 find_db_readers/writers 方法
    - 实现 find_redis_readers/writers 方法
    - _需求: 3.1, 3.2, 4.2, 5.2, 6.2, 7.2_

  - [ ]* 6.3 为搜索功能编写属性测试
    - **属性 28: 项目文件搜索完整性**
    - **验证需求: 8.1**

  - [ ]* 6.4 为搜索功能编写属性测试
    - **属性 29: 符号搜索完整性**
    - **验证需求: 8.2**

  - [ ]* 6.5 为搜索功能编写属性测试
    - **属性 30-33: HTTP/Kafka/DB/Redis 搜索完整性**
    - **验证需求: 8.3, 8.4, 8.5, 8.6**

  - [ ]* 6.6 为搜索模式编写属性测试
    - **属性 34: 搜索模式匹配正确性**
    - **验证需求: 8.7**

  - [ ]* 6.7 编写单元测试
    - 测试单个项目索引
    - 测试多项目索引
    - 测试符号冲突处理
    - _需求: 8.1, 8.2_

- [ ] 7. 实现 Impact Tracer 模块
  - [x] 7.1 实现基本追溯逻辑
    - 定义 ImpactTracer 结构体和 TraceConfig
    - 定义 ImpactNode 和 ImpactEdge 类型
    - 实现 trace_method_upstream 方法（DFS 算法）
    - 实现 trace_method_downstream 方法（DFS 算法）
    - 实现循环检测和深度限制
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6_

  - [ ]* 7.2 为方法追溯编写属性测试
    - **属性 9: 上游方法查找完整性**
    - **验证需求: 3.1**

  - [ ]* 7.3 为方法追溯编写属性测试
    - **属性 10: 下游方法查找完整性**
    - **验证需求: 3.2**

  - [ ]* 7.4 为递归追溯编写属性测试
    - **属性 11: 递归上游追溯传递性**
    - **属性 12: 递归下游追溯传递性**
    - **验证需求: 3.3, 3.4**

  - [ ]* 7.5 为循环检测编写属性测试
    - **属性 13: 循环调用检测终止性**
    - **验证需求: 3.5**

  - [ ]* 7.6 为深度限制编写属性测试
    - **属性 14: 深度限制有效性**
    - **验证需求: 3.6**

  - [x] 7.7 实现跨服务追溯逻辑
    - 实现 trace_cross_service 方法
    - 实现 HTTP 接口双向追溯
    - 实现 Kafka Topic 双向追溯
    - 实现数据库表双向追溯
    - 实现 Redis 键双向追溯
    - _需求: 4.2, 4.3, 5.2, 5.4, 6.2, 6.4, 7.2, 7.4_

  - [ ]* 7.8 为 HTTP 追溯编写属性测试
    - **属性 15: HTTP 接口信息提取准确性**
    - **属性 16: HTTP 双向追溯完整性**
    - **属性 17: HTTP 路径模式匹配正确性**
    - **验证需求: 4.1, 4.2, 4.3, 4.4**

  - [ ]* 7.9 为 Kafka 追溯编写属性测试
    - **属性 19: Kafka Topic 识别准确性**
    - **属性 20: Kafka 双向追溯完整性**
    - **属性 21: Kafka Topic 多源提取一致性**
    - **验证需求: 5.1, 5.2, 5.3, 5.4, 5.5**

  - [ ]* 7.10 为数据库追溯编写属性测试
    - **属性 22: 数据库表和操作类型识别准确性**
    - **属性 23: 数据库双向追溯完整性**
    - **属性 24: 数据库表多源提取一致性**
    - **验证需求: 6.1, 6.2, 6.3, 6.4, 6.5**

  - [ ]* 7.11 为 Redis 追溯编写属性测试
    - **属性 25: Redis 键识别准确性**
    - **属性 26: Redis 双向追溯完整性**
    - **属性 27: Redis 键前缀模式匹配正确性**
    - **验证需求: 7.1, 7.2, 7.3, 7.4, 7.5**

  - [ ]* 7.12 编写单元测试
    - 测试简单调用链
    - 测试跨服务追溯
    - 测试循环检测
    - 测试深度限制
    - _需求: 3.5, 3.6_

- [ ] 8. 实现 Graph Generator 模块
  - [x] 8.1 实现 ImpactGraph 结构体
    - 使用 petgraph 的 DiGraph 构建图结构
    - 实现 add_node 和 add_edge 方法
    - 实现节点和边的类型标注
    - _需求: 9.1, 9.2, 9.3_

  - [x] 8.2 实现图输出格式
    - 实现 to_dot 方法（使用 petgraph::dot）
    - 实现 to_json 方法（使用 serde_json）
    - 实现 detect_cycles 方法（使用 petgraph 的循环检测算法）
    - _需求: 9.4, 9.5_

  - [ ]* 8.3 为图生成编写属性测试
    - **属性 35: 影响图节点完整性**
    - **属性 36: 节点类型标注正确性**
    - **属性 37: 边标注正确性**
    - **验证需求: 9.1, 9.2, 9.3**

  - [ ]* 8.4 为图输出编写属性测试
    - **属性 38: 图格式输出往返一致性**
    - **属性 39: 循环依赖标记正确性**
    - **验证需求: 9.4, 9.5**

  - [ ]* 8.5 编写单元测试
    - 测试 DOT 格式输出
    - 测试 JSON 格式输出
    - 测试循环标记
    - _需求: 9.4, 9.5_

- [x] 9. 检查点 - 确保核心模块测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 10. 实现配置关联逻辑
  - [x] 10.1 实现配置到代码的关联
    - 在 CodeIndex 中添加配置关联映射
    - 实现配置值到代码引用的匹配逻辑
    - 支持 HTTP 接口地址关联
    - 支持 Kafka Topic 关联
    - 支持数据库表关联
    - _需求: 10.3, 10.4, 10.5_

  - [ ]* 10.2 为配置关联编写属性测试
    - **属性 42: HTTP 配置关联正确性**
    - **属性 43: Kafka 配置关联正确性**
    - **验证需求: 10.3, 10.4**

  - [ ]* 10.3 编写单元测试
    - 测试配置到代码的关联
    - 测试多个配置源的合并
    - _需求: 10.3, 10.4_

- [ ] 11. 实现 Analysis Orchestrator
  - [x] 11.1 实现主分析流程
    - 创建 AnalysisOrchestrator 结构体
    - 实现完整的分析流程：解析 patch -> 构建索引 -> 追溯影响 -> 生成图
    - 实现错误收集和警告汇总
    - 实现统计信息收集
    - _需求: 12.2, 12.4, 12.5_

  - [ ]* 11.2 为错误处理编写属性测试
    - **属性 45: 解析失败记录完整性**
    - **属性 46: 警告汇总完整性**
    - **验证需求: 12.2, 12.4**

  - [ ]* 11.3 为统计信息编写属性测试
    - **属性 47: 统计信息准确性**
    - **验证需求: 12.5**

  - [ ]* 11.4 编写单元测试
    - 测试完整分析流程
    - 测试错误恢复
    - 测试警告汇总
    - _需求: 12.2, 12.4_

- [ ] 12. 实现 CLI Interface
  - [x] 12.1 实现命令行参数解析
    - 使用 clap 定义 CLI 参数结构
    - 实现 workspace_path 和 diff_path 参数
    - 实现 output_format 参数（dot/json/mermaid）
    - 实现 max_depth 和 log_level 参数
    - _需求: 3.6, 9.4, 12.3_

  - [x] 12.2 实现主入口函数
    - 实现 run 函数连接所有模块
    - 初始化日志系统（env_logger）
    - 调用 AnalysisOrchestrator 执行分析
    - 输出结果到标准输出或文件
    - _需求: 12.1, 12.3_

  - [ ]* 12.3 编写单元测试
    - 测试参数解析
    - 测试路径不存在错误处理（示例 12.1）
    - 测试输出格式选择
    - _需求: 12.1_

- [ ] 13. 实现性能优化
  - [x] 13.1 添加并行处理支持
    - 使用 rayon 并行解析源文件
    - 实现线程安全的索引构建
    - _需求: 13.1_

  - [x] 13.2 实现解析缓存
    - 创建 ParseCache 结构体
    - 实现基于文件路径的缓存查询
    - 集成到 CodeIndex 构建流程
    - _需求: 13.2_

  - [ ]* 13.3 为缓存编写属性测试
    - **属性 48: 缓存一致性**
    - **验证需求: 13.2**

- [ ] 14. 集成测试和文档
  - [ ]* 14.1 编写端到端集成测试
    - 准备测试数据（小型多项目代码库和 patch 文件）
    - 测试完整的分析流程
    - 验证输出图的正确性
    - _需求: 1.1, 2.1, 3.1, 4.1, 5.1, 6.1, 7.1, 9.1_

  - [x] 14.2 编写 README 和使用文档
    - 说明工具的用途和功能
    - 提供安装和使用示例
    - 说明输出格式和可视化方法
    - _需求: 所有需求_

- [x] 15. 最终检查点 - 确保所有测试通过
  - 运行所有单元测试和属性测试
  - 运行集成测试
  - 确保所有测试通过，如有问题请询问用户

## 注意事项

- 标记 `*` 的任务是可选的，可以跳过以更快实现 MVP
- 每个任务都引用了具体的需求以保证可追溯性
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证具体示例和边缘情况
- 所有属性测试应配置为至少运行 100 次迭代
